name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    env:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_pass
      POSTGRES_AUTH_DB: auth_db
      POSTGRES_AUTH_HOST: auth_db
      POSTGRES_TOURNAMENT_DB: tournament_db
      POSTGRES_TOURNAMENT_HOST: tournament_db
      POSTGRES_HISTORY_DB: history_db
      POSTGRES_HISTORY_HOST: history_db
      CLOUDFLARE_TUNNEL_TOKEN: dummy
      POSTGRES_PORT: 5432
      SECRET_KEY: test-secret-key
      SECRET_KEY_HISTORY: test-secret-key-history
      SECRET_KEY_TOURNAMENT: test-secret-key-tournament
      JWT_ALGO: HS256


    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # - name: Run unit test
      #   run: TODO

      - name: Build Docker images
        run: docker compose build

      - name: Integration Test( backend auth-service)
        run: docker compose run --rm auth-service python manage.py test auth_app

      - name: Clean up containers
        run: docker compose down

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PA_TOKEN }} #expire in 90 days!
          
      - name: Build and push proxy image
        uses: docker/build-push-action@v5
        with:
          context: ./proxy
          file: ./proxy/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/proxy:${{ github.sha }}

      - name: Build and push auth-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/auth_service
          file: ./backend/auth_service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:${{ github.sha }}

      - name: Build and push tournament-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/tournament-service
          file: ./backend/tournament-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/tournament-service:${{ github.sha }}

      - name: Build and push history-service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/history
          file: ./backend/history/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/history-service:${{ github.sha }}


  cd:
    name: Continuous Deployment
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Create venv and install Ansible and community.docker
        run: |
          cd ansible
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.docker

      - name: Export Hetzner VPS IP to environment
        run: echo "HETZNER_IP=${{ secrets.HETZNER_IP }}" >> $GITHUB_ENV
        
      - name: Write ansible vault password to a file
        run: echo "${{ secrets.ANSIBLE_VAULT_PASS }}" > ansible/.vault_pass.txt

      - name: Write SSH key for runner
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" >> ~/.ssh/id_hetzner
          chmod 400 ~/.ssh/id_hetzner
    
      - name: Run ansible Deploy playbook
        run: |
          cd ansible
          source venv/bin/activate
          ansible-playbook playbooks/deploy.yml --vault-password-file .vault_pass.txt  -e 'ansible_ssh_common_args="-o StrictHostKeyChecking=no"' -e "docker_image_tag=${{ github.sha }}"